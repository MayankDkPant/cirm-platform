# CIRM – AI Orchestration Contract
Version: 1.0
Status: Controlled Evolution Only

---

# 1. AI Role Definition

AI in CIRM is an enrichment layer.

AI may:
- Classify departments
- Suggest priority
- Structure complaint drafts
- Provide civic information
- Suggest navigation actions (via metadata)

AI may NOT:
- Change complaint status
- Close complaints
- Escalate autonomously
- Override governance authority
- Directly modify database state

AI output must always be validated by backend before use.

---

# 2. AI Response Structure (Mandatory Contract)

AI must return structured JSON.

Required format:

{
  "content": string,
  "confidence": number,
  "actions": Action[]
}

Where:

confidence:
- Float between 0 and 1
- Generated by backend if model does not provide

actions:
Optional array.

Action format:

{
  "type": "navigate",
  "target": string,
  "label": string,
  "params": object (optional)
}

Frontend must NEVER parse natural language for action detection.

All navigation must be metadata-driven.

---

# 3. AI Request Types

AI requests fall into two categories:

---

## 3.1 Informational Query (RAG Enabled)

Purpose:
- Answer civic questions
- Provide structured explanation

Flow:
User Query
→ Backend receives
→ Context retrieval (future)
→ RAG retrieval
→ Prompt construction
→ LLM inference
→ JSON validation
→ Response returned

No database mutation allowed.

---

## 3.2 Complaint Draft Assistance (Stateless)

Purpose:
- Extract structured complaint from free text

Input:
Natural language description.

Output must include:

{
  "title": string,
  "description": string,
  "category": string,
  "ward": string,
  "priority": string,
  "confidence": number
}

Backend validates before saving.

AI does not save directly.

---

# 4. Prompt Construction Rules

Prompt must:

- Be role-based (system instruction)
- Clearly define structured output requirement
- Explicitly forbid additional keys
- Forbid markdown outside JSON
- Forbid conversational tone in structured extraction

Example instruction pattern:

"You are a civic assistant. Return only valid JSON matching the required schema. Do not include explanation outside JSON."

Prompt must be versioned.

---

# 5. Confidence Handling

If model provides confidence:
→ Use model confidence.

If not:
→ Backend assigns derived confidence based on:
   - Classification certainty
   - RAG retrieval relevance
   - Rule-based heuristics

Confidence must always be numeric (0–1).

Frontend displays percentage.

Confidence must never be hidden.

---

# 6. Action Metadata Rules

Actions must:

- Be explicitly generated in JSON
- Include a clear label
- Map to valid navigation targets

Backend must validate:

- Target exists
- Params match expected navigation schema
- Action type is supported

No raw LLM-generated navigation strings allowed.

---

# 7. Context Injection (Phase 2+)

When context-aware AI is enabled:

Backend may inject:

- Open complaint count
- Status distribution
- Ward data
- SLA delay indicators

Context must be structured.
Never inject raw database dump.

Context must be minimal and relevant.

---

# 8. RAG Policy (Future)

When RAG is enabled:

- Source documents must be controlled
- Retrieval must be filtered by ward/city
- Model must not fabricate policy citations
- Citation metadata must be returned separately

Future response structure may evolve to:

{
  content: string,
  confidence: number,
  actions: [],
  citations: [
    {
      title: string,
      source: string,
      url: string
    }
  ]
}

Citations must not be hallucinated.

---

# 9. Validation Layer (Backend Responsibility)

Before returning AI output to mobile:

Backend must:

- Validate JSON schema
- Remove unsupported fields
- Validate action targets
- Sanitize text output
- Enforce maximum length
- Log request and response

Invalid AI output must be rejected and retried if necessary.

AI output is untrusted input.

---

# 10. Logging & Lakehouse Policy

Every AI interaction must log:

- Prompt version
- Model version
- Input text
- Output JSON
- Confidence
- Timestamp

Stored in:
AIConversation / AIMessage
and lakehouse storage for training refinement.

Conversation persistence is permanent.
UI session display is temporary.

---

# 11. Forbidden Practices

The following are prohibited:

- Parsing natural language to determine navigation
- Allowing AI to decide complaint lifecycle transitions
- Directly trusting LLM JSON without validation
- Embedding business logic inside prompt text
- Hardcoding AI decisions in mobile layer
- Skipping confidence propagation

AI orchestration must remain backend-controlled.

---

# 12. Evolution Protocol

Any modification to:

- Response schema
- Action schema
- Confidence model
- Prompt template
- RAG structure

Requires:

1. Contract update
2. Version bump
3. Backward compatibility review
4. Frontend type update
5. Backend validation update

No silent schema drift allowed.

---

End of AI Orchestration Contract.
